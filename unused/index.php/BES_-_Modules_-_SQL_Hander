
<!DOCTYPE html>
<html lang="en" dir="ltr" class="client-nojs">
<head>
<title>BES - Modules - SQL Hander - OPeNDAP Documentation</title>
</head>
<body class="mediawiki ltr sitedir-ltr ns-0 ns-subject page-BES_-_Modules_-_SQL_Hander skin-monobook action-view">
<div id="globalWrapper">
<div id="column-content"><div id="content" class="mw-body-primary" role="main">
	
	
	<h1 id="firstHeading" class="firstHeading" lang="en"><span dir="auto">BES - Modules - SQL Hander</span></h1>
	<div id="bodyContent" class="mw-body">
		<div id="siteSub">From OPeNDAP Documentation</div>
		<div id="contentSub"></div>
		

		<!-- start content -->
<div id="mw-content-text" lang="en" dir="ltr" class="mw-content-ltr"><div id="toc" class="toc"><div id="toctitle"><h2>Contents</h2></div>
<ul>
<li class="toclevel-1 tocsection-1"><a href="#Kinds_of_files_the_handler_will_serve"><span class="tocnumber">1</span> <span class="toctext">Kinds of files the handler will serve</span></a>
<ul>
<li class="toclevel-2 tocsection-2"><a href="#Mappings_between_the_ODBC_data_types_and_DAP2_data_types"><span class="tocnumber">1.1</span> <span class="toctext">Mappings between the ODBC data types and DAP2 data types</span></a></li>
<li class="toclevel-2 tocsection-3"><a href="#Known_problems"><span class="tocnumber">1.2</span> <span class="toctext">Known problems</span></a></li>
</ul>
</li>
<li class="toclevel-1 tocsection-4"><a href="#Configuration_parameters"><span class="tocnumber">2</span> <span class="toctext">Configuration parameters</span></a>
<ul>
<li class="toclevel-2 tocsection-5"><a href="#Configuring_the_ODBC_Driver"><span class="tocnumber">2.1</span> <span class="toctext">Configuring the ODBC Driver</span></a></li>
<li class="toclevel-2 tocsection-6"><a href="#Configuring_the_handler"><span class="tocnumber">2.2</span> <span class="toctext">Configuring the handler</span></a>
<ul>
<li class="toclevel-3 tocsection-7"><a href="#SQL.CheckPoint"><span class="tocnumber">2.2.1</span> <span class="toctext">SQL.CheckPoint</span></a></li>
</ul>
</li>
<li class="toclevel-2 tocsection-8"><a href="#Configuring_Datasets"><span class="tocnumber">2.3</span> <span class="toctext">Configuring Datasets</span></a>
<ul>
<li class="toclevel-3 tocsection-9"><a href="#Information_in_the_section_part_of_the_dataset_file"><span class="tocnumber">2.3.1</span> <span class="toctext">Information in the <i>section</i> part of the dataset file</span></a></li>
<li class="toclevel-3 tocsection-10"><a href="#The_select_part"><span class="tocnumber">2.3.2</span> <span class="toctext">The <i>select</i> part</span></a></li>
<li class="toclevel-3 tocsection-11"><a href="#The_from_and_where_parts"><span class="tocnumber">2.3.3</span> <span class="toctext">The <i>from</i> and <i>where</i> parts</span></a></li>
<li class="toclevel-3 tocsection-12"><a href="#The_other_part"><span class="tocnumber">2.3.4</span> <span class="toctext">The <i>other</i> part</span></a></li>
<li class="toclevel-3 tocsection-13"><a href="#Using_variables"><span class="tocnumber">2.3.5</span> <span class="toctext">Using variables</span></a></li>
<li class="toclevel-3 tocsection-14"><a href="#Some_example_dataset_files"><span class="tocnumber">2.3.6</span> <span class="toctext">Some example dataset files</span></a></li>
</ul>
</li>
</ul>
</li>
</ul>
</div>

<h2><span class="mw-headline" id="Kinds_of_files_the_handler_will_serve"><span class="mw-headline-number">1</span> Kinds of files the handler will serve</span></h2>
<p>This handler will serve data stored in a relational database if that database is configured to be accessed using ODBC. The handler has been tested using both the unixODBC and iODBC driver managers on Linux and OS/X, respectively. While our testing has been limited to the MySQL and Postgres database servers, the handler is not specific to either of those severs; it should work with any database that can be accessed using an ODBC driver.
</p><p>The handler can be configured to combine information from several tables and provide access to it as a single dataset, including performing the full range of SQL operations. At the same time, the SQL database server is never exposed to the web using this handler, so the database contents are safe.
</p>
<h3><span class="mw-headline" id="Mappings_between_the_ODBC_data_types_and_DAP2_data_types"><span class="mw-headline-number">1.1</span> Mappings between the ODBC data types and DAP2 data types</span></h3>
<p>The SQL Handler maps the datatypes defined by SQL into types defined by DAP. In most cases the mapping is obvious. Here we document each of the supported SQL types and their corresponding DAP type. Note that any types not listed here causes a runtime fatal error. That is, if you include in the <i>[select]</i> part of the dataset file the name of a column with an unsupported data type, the handler will return an error saying <i>SQL Handler: The datatype read from the Data Source is not supported. The problem type code is: &lt;type code&gt;</i>. 
</p><p>Here's a table that maps ODBC to/from SQL: <a rel="nofollow" class="external free" href="http://publib.boulder.ibm.com/infocenter/dzichelp/v2r2/index.jsp?topic=%2Fcom.ibm.db2.doc.odbc%2Fbjneappl1009305.htm">http://publib.boulder.ibm.com/infocenter/dzichelp/v2r2/index.jsp?topic=%2Fcom.ibm.db2.doc.odbc%2Fbjneappl1009305.htm</a>
</p>
<table class="wikitable">
<caption> The Mapping between ODBC and DAP datatypes
</caption>
<tr>
<th> ODBC Type
</th>
<th> DAP Type
</th>
<th> Comments
</th></tr>
<tr>
<td>  SQL_C_CHAR </td>
<td> Str </td>
<td>
</td></tr>
<tr>
<td> SQL_C_SLONG, SQL_C_LONG </td>
<td> Int32 </td>
<td>
</td></tr>
<tr>
<td> SQL_C_SHORT</td>
<td> Int16 </td>
<td>
</td></tr>
<tr>
<td> SQL_C_FLOAT </td>
<td> Float32 </td>
<td>
</td></tr>
<tr>
<td> SQL_C_DOUBLE </td>
<td> Float64  </td>
<td>
</td></tr>
<tr>
<td> SQL_C_NUMERIC </td>
<td> Int32 </td>
<td>
</td></tr>
<tr>
<td> SQL_C_DEFAULT </td>
<td> Str </td>
<td>
</td></tr>
<tr>
<td>  SQL_C_DATE, SQL_C_TIME, SQL_C_TIMESTAMP,<br />SQL_C_TYPE_DATE, SQL_C_TYPE_TIME, SQL_C_TYPE_TIMESTAMP </td>
<td> Str </td>
<td>
</td></tr>
<tr>
<td> SQL_C_BINARY, SQL_C_BIT </td>
<td> Int16 </td>
<td>
</td></tr>
<tr>
<td> SQL_C_SBIGINT, SQL_C_UBIGINT </td>
<td> Int32 </td>
<td>
</td></tr>
<tr>
<td> SQL_C_TINYINT, SQL_C_SSHORT, SQL_C_STINYINT </td>
<td> Int16 </td>
<td>
</td></tr>
<tr>
<td> SQL_C_ULONG, SQL_C_USHORT </td>
<td> Int32 </td>
<td>
</td></tr>
<tr>
<td> SQL_C_UTINYINT </td>
<td> Int32 </td>
<td>
</td></tr>
<tr>
<td> SQL_C_CHAR </td>
<td> Str </td>
<td>
</td></tr>
<tr>
<td> SQL_C_CHAR </td>
<td> Str </td>
<td>
</td></tr></table>
<table class="wikitable">
<caption> The Mapping between SQL and ODBC datatypes
</caption>
<tr>
<th> SQL Type
</th>
<th> ODBC Type
</th></tr>
<tr>
<td> SQL_CHAR, SQL_VARCHAR, SQL_LONGVARCHAR </td>
<td>
</td></tr>
<tr>
<td> SQL_WCHAR, SQL_WVARCHAR, SQL_WCHAR </td>
<td>
</td></tr>
<tr>
<td> SQL_DECIMAL, SQL_NUMERIC </td>
<td>
</td></tr></table>
<h3><span class="mw-headline" id="Known_problems"><span class="mw-headline-number">1.2</span> Known problems</span></h3>
<p>There are no known problems.
</p>
<h2><span class="mw-headline" id="Configuration_parameters"><span class="mw-headline-number">2</span> Configuration parameters</span></h2>
<h3><span class="mw-headline" id="Configuring_the_ODBC_Driver"><span class="mw-headline-number">2.1</span> Configuring the ODBC Driver</span></h3>
<p>To configure the handler the handler itself must be told which tables, or parts of tables, should be accessed and the ODBC driver must be configured. In general, ODBC drivers are pretty easy to configure and, while each driver has its idiosyncrasies, most of the setup is the same for any driver/database combination. Both <i>unixODBC</i> and <i>iODBC</i> use two configuration fills: <i>/etc/odbcinst.ini</i> and <i>/etc/odbc.ini</i>. The driver should have documentation on these files and their setup. There is one parameter you will need to know to make use of the sql handler. In the <i>odbc.ini</i> file, the parameter <i>database</i> is used to reference the actual database that is matched to particular <i>Data Source Name</i> (DSN). You will need to know the DSN since programs that use ODBC to access a database use the DSN and not the name of the database. In addition, there is a <i>user</i> and <i>password</i> parameter set defined for a particular DSN; the sql handler will likely need that too (NB: This might not actually be needed 9/9/12).
</p><p>What the configuration files look like on OSX:
</p><p>This file likely will no change. odbcinst.ini:
</p>
<div dir="ltr" class="mw-geshi mw-code mw-content-ltr"><div class="ini source-ini"><pre class="de1"><span class="re0"><span class="br0">&#91;</span>ODBC Drivers<span class="br0">&#93;</span></span>
MySQL ODBC <span class="nu0">5.1</span> Driver <span class="sy0">=</span><span class="re2"> Installed</span>
<span class="re1">psqlODBC</span>              <span class="sy0">=</span><span class="re2"> Installed</span>
&#160;
<span class="re0"><span class="br0">&#91;</span>ODBC Connection Pooling<span class="br0">&#93;</span></span>
<span class="re1">PerfMon</span>    <span class="sy0">=</span><span class="re2"> 0</span>
Retry Wait <span class="sy0">=</span> 
&#160;
<span class="re0"><span class="br0">&#91;</span>psqlODBC<span class="br0">&#93;</span></span>
<span class="re1">Description</span> <span class="sy0">=</span><span class="re2"> PostgreSQL ODBC driver</span>
<span class="re1">Driver</span>      <span class="sy0">=</span><span class="re2"> /Library/PostgreSQL/psqlODBC/lib/psqlodbcw.so</span>
&#160;
<span class="re0"><span class="br0">&#91;</span>MySQL ODBC 5.1 Driver<span class="br0">&#93;</span></span>
<span class="re1">Driver</span> <span class="sy0">=</span><span class="re2"> /usr/local/lib/libmyodbc5.so</span></pre></div></div>
<p>This file holds information about the database name and the Data Source Name (DSN). Here it's creatively named 'test'. odbc.ini:
</p>
<div dir="ltr" class="mw-geshi mw-code mw-content-ltr"><div class="ini source-ini"><pre class="de1"><span class="re0"><span class="br0">&#91;</span>ODBC Data Sources<span class="br0">&#93;</span></span>
<span class="re1">data_source_name</span> <span class="sy0">=</span><span class="re2"> test</span>
&#160;
<span class="re0"><span class="br0">&#91;</span>ODBC<span class="br0">&#93;</span></span>
<span class="re1">Trace</span>         <span class="sy0">=</span><span class="re2"> 0</span>
<span class="re1">TraceAutoStop</span> <span class="sy0">=</span><span class="re2"> 0</span>
<span class="re1">TraceFile</span>     <span class="sy0">=</span>
<span class="re1">TraceLibrary</span>  <span class="sy0">=</span>
&#160;
<span class="re0"><span class="br0">&#91;</span>test<span class="br0">&#93;</span></span>
<span class="re1">Description</span> <span class="sy0">=</span><span class="re2"> MySQL test database</span>
<span class="re1">Trace</span>       <span class="sy0">=</span><span class="re2"> Yes</span>
<span class="re1">TraceFile</span>   <span class="sy0">=</span><span class="re2"> sql.log</span>
<span class="re1">Driver</span>      <span class="sy0">=</span><span class="re2"> MySQL ODBC 5.1 Driver</span>
<span class="re1">Server</span>      <span class="sy0">=</span><span class="re2"> localhost</span>
<span class="re1">User</span>        <span class="sy0">=</span><span class="re2"> jimg</span>
<span class="re1">Password</span>    <span class="sy0">=</span>
<span class="re1">Port</span>        <span class="sy0">=</span><span class="re2"> 3306</span>
<span class="re1">DATABASE</span>    <span class="sy0">=</span><span class="re2"> test</span>
<span class="re1">Socket</span>      <span class="sy0">=</span><span class="re2"> /tmp/mysql.sock</span></pre></div></div>
<h3><span class="mw-headline" id="Configuring_the_handler"><span class="mw-headline-number">2.2</span> Configuring the handler</span></h3>
<h4><span class="mw-headline" id="SQL.CheckPoint"><span class="mw-headline-number">2.2.1</span> SQL.CheckPoint</span></h4>
<p>Checkpoints in the SQL handler are phases of the database access process where error conditions can be tested for and reported. If these are activated using the <i>SQL.CheckPoint</i> parameter and an error is found, then a message will be printed in the bes.log and an exception will be thrown. There are five checkpoints supported by the handler:
</p>
<dl>
<dt>CONNECT</dt>
<dd> 1 (Fatal error)
</dd>
<dt>CLOSE</dt>
<dd> 2
</dd>
<dt>QUERY</dt>
<dd> 3
</dd>
<dt>GET_NEXT</dt>
<dd> 4 (Recoverable error)
</dd>
<dt>NEXT_ROW</dt>
<dd> 5
</dd>
</dl>
<p>The default for the handler is to test for and report all errors:
</p>
<pre>SQL.CheckPoint=1,2,3,4,5
</pre>
<h3><span class="mw-headline" id="Configuring_Datasets"><span class="mw-headline-number">2.3</span> Configuring Datasets</span></h3>
<p>One aspect of the SQL handler that sets it appart from other handlers is that the datasets it serves are not files or collections of files. Instead they are values read from one or more tables in a database. The handler uses one file for each dataset it serves; we call them <i>dataset files</i>. Within a dataset file there are several sections that define which Data Set Name (DSN) to use (recall that the DSN is set in the <i>odbc.ini</i> file which maps the DSN to a particular database, user and password), which tables, how to combine them and which columns to <i>select</i> and if any other constraints should be applied when retrieving the values from the database server. As a data provider, you should plan on having a dataset file for each dataset you want people to access, even if those all come from the same table. 
</p><p>A dataset file has five sections:
</p>
<dl>
<dt>section</dt>
<dd> This is where the DSN and other information are given
</dd>
<dt>select</dt>
<dd> Here the arguments to passed to select are given. This may be <i>*</i> or the names of columns, just as with an SQL <i>SELECT</i> statement
</dd>
<dt>from</dt>
<dd> The names of the tables. This is just like the <i>FROM</i> part of an SQL <i>SELECT</i> statement.
</dd>
<dt>where</dt>
<dd> You're probably seeing a pattern by now: SELECT ... FROM ... WHERE 
</dd>
<dt>other</dt>
<dd> Driver-specific parameters
</dd>
</dl>
<p>Each of the sections is denoted by starting a line in the dataset file with its name in square brackets such as:
</p>
<pre>[section]
</pre>
<p>or
</p>
<pre>[select]
</pre>
<h4><span class="mw-headline" id="Information_in_the_section_part_of_the_dataset_file"><span class="mw-headline-number">2.3.1</span> Information in the <i>section</i> part of the dataset file</span></h4>
<p>There are six parameters that may be set in the <i>select</i> part of the dataset file:
</p>
<dl>
<dt>api</dt>
<dd> Currently this must be <i>odbc</i>
</dd>
<dt>server</dt>
<dd> The DSN.
</dd>
<dt>user, pass, dbname, port</dt>
<dd> Unused. These are detected by the code, however, and can be used by a new submodule that connects to a database using a scheme other than ODBC. For example, if you were to specialize the connection mechanism so that it used a database's native API, these keywords could be used to set the database name, user, etc., in place of the ODBC DSN. In that case the value of <i>api</i> would need to be the base name of the new connection specialization.
</dd>
</dl>
<p>Note that a dataset file may have several [section] parts, each which lists a different DSN. This provides a failover capability so that if the same information (or similar enough to be accessible using the same SQL statement) exists both locally and remotely, both sources can be given. For example, suppose that your institution maintains a database with many thousands of observations and you want to serve a subset of those. You have a copy of those data on your own computer too, but you would rather have people access the data from the institution's high performance hardware. You can list both DSNs, knowing that the first listed will get preference.
</p>
<h4><span class="mw-headline" id="The_select_part"><span class="mw-headline-number">2.3.2</span> The <i>select</i> part</span></h4>
<p>This part lists the columns to include as you would write them in an SQL SELECT statement. 
Each column name has to be unique. You can use aliases (defined in the preamble of the dataset file) to define different names for two columns from different database tables that are the same. For example, you could define aliases like these:
</p>
<pre>table1.theColumn as col1
table2.theColumn as col2
</pre>
<p>and then use <i>col1,col2</i> in the select part of the dataset file
</p>
<h4><span class="mw-headline" id="The_from_and_where_parts"><span class="mw-headline-number">2.3.3</span> The <i>from</i> and <i>where</i> parts</span></h4>
<p>Each of these parts are simply substituted and passed to the database just as you would expect. Note that you do not include the actual words <i>FROM</i> or <i>WHERE</i>, just the contents of those parts of the SQL statement.
</p>
<h4><span class="mw-headline" id="The_other_part"><span class="mw-headline-number">2.3.4</span> The <i>other</i> part</span></h4>
<p>Entries in this parts should be of the form <i>key = value</i>, one per line. They are taken as a group and passed to the ODBC driver. Use this section to provide any parameters that are specific to a particular driver.
</p>
<h4><span class="mw-headline" id="Using_variables"><span class="mw-headline-number">2.3.5</span> Using variables</span></h4>
<p>The dataset files also support 'variables' that can be used to define a name once and then use it repeatedly by simply using the variable name instead. Then if you decide to read from a different table, only the variable definition needs to be changed. Variables are defined as the beginning o the dataset file, before the <i>section</i> part. The syntax for variable is simple: <i>define $variable$ = value</i>, one per line (the <i>$</i> characters are literal, as is the word <i>define</i>). To reference a variable, use <i>$variable$</i> wherever you would otherwise use a literal.
</p>
<h4><span class="mw-headline" id="Some_example_dataset_files"><span class="mw-headline-number">2.3.6</span> Some example dataset files</span></h4>
<pre>
[section]
#  Required.
api=odbc

# This is the name of the configured DSN 
server=MySQL_DSN

[select]
# The attribute list to query
# NOTE: The order used here will be kept in the results
id, wind_chill, description

[from]
# The table to use can be a complex FROM clause
wind_08_2010

[where]
# this is optional constraint which will be applied to ALL
# the requests and can be used to limit the shared data.
id&lt;100
</pre>


</div>
				<!-- end content -->
				<div class="visualClear"></div>
	</div>
</div></div>
</body></html>