
<!DOCTYPE html>
<html lang="en" dir="ltr" class="client-nojs">
<head>
<title>NCML Module Aggregation JoinExisting - OPeNDAP Documentation</title>
</head>
<body class="mediawiki ltr sitedir-ltr ns-0 ns-subject page-NCML_Module_Aggregation_JoinExisting skin-monobook action-view">
<div id="globalWrapper">
<div id="column-content"><div id="content" class="mw-body-primary" role="main">
	
	
	<h1 id="firstHeading" class="firstHeading" lang="en"><span dir="auto">NCML Module Aggregation JoinExisting</span></h1>
	<div id="bodyContent" class="mw-body">
		<div id="siteSub">From OPeNDAP Documentation</div>
		<div id="contentSub"></div>
		

		<!-- start content -->
<div id="mw-content-text" lang="en" dir="ltr" class="mw-content-ltr"><p>Join Existing Aggregation
</p>
<div id="toc" class="toc"><div id="toctitle"><h2>Contents</h2></div>
<ul>
<li class="toclevel-1 tocsection-1"><a href="#Overview"><span class="tocnumber">1</span> <span class="toctext">Overview</span></a>
<ul>
<li class="toclevel-2 tocsection-2"><a href="#Content_summary"><span class="tocnumber">1.1</span> <span class="toctext">Content summary</span></a></li>
</ul>
</li>
<li class="toclevel-1 tocsection-3"><a href="#Examples"><span class="tocnumber">2</span> <span class="toctext">Examples</span></a>
<ul>
<li class="toclevel-2 tocsection-4"><a href="#Granules"><span class="tocnumber">2.1</span> <span class="toctext">Granules</span></a></li>
<li class="toclevel-2 tocsection-5"><a href="#Explicit_Listing_of_Granules"><span class="tocnumber">2.2</span> <span class="toctext">Explicit Listing of Granules</span></a></li>
<li class="toclevel-2 tocsection-6"><a href="#Using_the_Scan_Element"><span class="tocnumber">2.3</span> <span class="toctext">Using the Scan Element</span></a>
<ul>
<li class="toclevel-3 tocsection-7"><a href="#NcML_Dimension_Cache"><span class="tocnumber">2.3.1</span> <span class="toctext">NcML Dimension Cache</span></a></li>
<li class="toclevel-3 tocsection-8"><a href="#ncoords_extension"><span class="tocnumber">2.3.2</span> <span class="toctext">ncoords extension</span></a></li>
</ul>
</li>
</ul>
</li>
<li class="toclevel-1 tocsection-9"><a href="#Limitations"><span class="tocnumber">3</span> <span class="toctext">Limitations</span></a>
<ul>
<li class="toclevel-2 tocsection-10"><a href="#Join_Dimension_Sizes_Should_Be_Explicitly_Declared"><span class="tocnumber">3.1</span> <span class="toctext">Join Dimension Sizes Should Be Explicitly Declared</span></a></li>
<li class="toclevel-2 tocsection-11"><a href="#Source_of_Data_for_Aggregated_Coordinate_Variable_on_Join_Dimension"><span class="tocnumber">3.2</span> <span class="toctext">Source of Data for Aggregated Coordinate Variable on Join Dimension</span></a></li>
<li class="toclevel-2 tocsection-12"><a href="#Source_of_Join_Dimension_Metadata"><span class="tocnumber">3.3</span> <span class="toctext">Source of Join Dimension Metadata</span></a></li>
</ul>
</li>
</ul>
</div>

<h2><span class="mw-headline" id="Overview"><span class="mw-headline-number">1</span> Overview</span></h2>
<p>A <i>joinExisting</i> aggregation joins multiple granule datasets by concatenating the specified outer dimensional data from the granules into the output.  This results in matrices of the same number of dimensions, but with larger outer dimension cardinality.  The outer dimension sizes of the granules may vary across granule, but any inner dimensions for multi-dimensional data still are required to match.  
</p><p>The reader is also directed to a basic tutorial of this NcML aggregation which may be found at <a rel="nofollow" class="external free" href="http://www.unidata.ucar.edu/software/netcdf/ncml/v2.2/Aggregation.html#joinExisting">http://www.unidata.ucar.edu/software/netcdf/ncml/v2.2/Aggregation.html#joinExisting</a>.  Note that version 1.1.0 of the module does not support all features of joinExisting!  Future versions will add more features.
</p><p><b>PLEASE NOTE</b> that our syntax is slightly different than that of the THREDDS Data Server (TDS), so please refer to this tutorial when using the Hyrax NcML Module!  In particular, we do not process the &lt;aggregation&gt; element prior to other elements in the dataset, so in some cases the relative ordering of the &lt;aggregation&gt; and references to variables within the aggregation matters.
</p>
<h3><span class="mw-headline" id="Content_summary"><span class="mw-headline-number">1.1</span> Content summary</span></h3>
<p>This page describes the behavior of the initial implementation of joinExisting for version 1.2.x of the NcML Module, bundled with Hyrax 1.8.  It is a limited feature set described below.  Please see the Limitations section for more information.
</p><p>In version 1.2.x, a joinExisting aggregation may be specified in three ways:
</p>
<ul>
<li> Using explicit lists of <b>netcdf</b> elements with the the <i>ncoords</i> attribute correctly specified for all of them.
</li>
<li> Leaving off the <i>ncoords</i> attribute for all of the <i>netcdf</i> elements.
</li>
<li> Using a <b>scan</b> element with <i>ncoords</i> specified and all matching granule datasets having this dimension size
</li>
</ul>
<p>Our example below will clarify this.
</p><p>Future versions of the module  will implement more of the joinExisting feature set.
</p>
<h2><span class="mw-headline" id="Examples"><span class="mw-headline-number">2</span> Examples</span></h2>
<p>Here we give an example that illustrates the functionality offered by the current version of the aggregation.  This example may also be found on:
</p><p><a rel="nofollow" class="external free" href="http://test.opendap.org:8090/opendap/ioos/mday_joinExist.ncml">http://test.opendap.org:8090/opendap/ioos/mday_joinExist.ncml</a>
</p><p>with the data granules located in
</p><p><a rel="nofollow" class="external free" href="http://test.opendap.org:8090/opendap/coverage/mday/">http://test.opendap.org:8090/opendap/coverage/mday/</a>
</p>
<h3><span class="mw-headline" id="Granules"><span class="mw-headline-number">2.1</span> Granules</span></h3>
<p>Assume we have some number of granule datasets with a DDS the same as the following (modulo the dataset name):
</p>
<pre>
Dataset {
    Grid {
      Array:
        Float32 PHssta[time = 1][altitude = 1][lat = 4096][lon = 8192];
      Maps:
        Float64 time[time = 1];
        Float64 altitude[altitude = 1];
        Float64 lat[lat = 4096];
        Float64 lon[lon = 8192];
    } PHssta;
} PH2006001_2006031_ssta.nc;
</pre>
<h3><span class="mw-headline" id="Explicit_Listing_of_Granules"><span class="mw-headline-number">2.2</span> Explicit Listing of Granules</span></h3>
<p>We see that here <i>time</i> is the outer dimension, which is the only dimension we may join along (it is an error to specify an inner). Given some number of granules with this same shape, consider the following explicit joinExisting aggregation:
</p>
<div dir="ltr" class="mw-geshi mw-code mw-content-ltr"><div class="xml source-xml"><pre class="de1"><span class="sc3"><span class="re1">&lt;?xml</span> <span class="re0">version</span>=<span class="st0">&quot;1.0&quot;</span> <span class="re0">encoding</span>=<span class="st0">&quot;UTF-8&quot;</span><span class="re2">?&gt;</span></span>
&#160;
<span class="sc3"><span class="re1">&lt;netcdf</span> <span class="re0">title</span>=<span class="st0">&quot;joinExisting test on netcdf Grid granules&quot;</span><span class="re2">&gt;</span></span>
&#160;
  <span class="sc3"><span class="re1">&lt;aggregation</span> <span class="re0">type</span>=<span class="st0">&quot;joinExisting&quot;</span> <span class="re0">dimName</span>=<span class="st0">&quot;time&quot;</span> <span class="re2">&gt;</span></span>
    <span class="sc-1">&lt;!-- Note explicit use of ncoords specifying size of &quot;time&quot; --&gt;</span>
    <span class="sc3"><span class="re1">&lt;netcdf</span> <span class="re0">location</span>=<span class="st0">&quot;/coverage/mday/PH2006001_2006031_ssta.nc&quot;</span> <span class="re0">ncoords</span>=<span class="st0">&quot;1&quot;</span><span class="re2">/&gt;</span></span>
    <span class="sc3"><span class="re1">&lt;netcdf</span> <span class="re0">location</span>=<span class="st0">&quot;/coverage/mday/PH2006032_2006059_ssta.nc&quot;</span> <span class="re0">ncoords</span>=<span class="st0">&quot;1&quot;</span><span class="re2">/&gt;</span></span>
    <span class="sc3"><span class="re1">&lt;netcdf</span> <span class="re0">location</span>=<span class="st0">&quot;/coverage/mday/PH2006060_2006090_ssta.nc&quot;</span> <span class="re0">ncoords</span>=<span class="st0">&quot;1&quot;</span><span class="re2">/&gt;</span></span>
  <span class="sc3"><span class="re1">&lt;/aggregation<span class="re2">&gt;</span></span></span>
&#160;
<span class="sc3"><span class="re1">&lt;/netcdf<span class="re2">&gt;</span></span></span></pre></div></div>
<p>Here's the same aggregation using the <i>scan</i> element instead of explicitly listing each file:
</p>
<div dir="ltr" class="mw-geshi mw-code mw-content-ltr"><div class="xml source-xml"><pre class="de1"><span class="sc3"><span class="re1">&lt;?xml</span> <span class="re0">version</span>=<span class="st0">&quot;1.0&quot;</span> <span class="re0">encoding</span>=<span class="st0">&quot;UTF-8&quot;</span><span class="re2">?&gt;</span></span>
&#160;
<span class="sc3"><span class="re1">&lt;netcdf</span> <span class="re0">title</span>=<span class="st0">&quot;joinExisting test on netcdf Grid granules using scan&quot;</span><span class="re2">&gt;</span></span>
&#160;
  <span class="sc3"><span class="re1">&lt;aggregation</span> <span class="re0">type</span>=<span class="st0">&quot;joinExisting&quot;</span> <span class="re0">dimName</span>=<span class="st0">&quot;time&quot;</span> <span class="re2">&gt;</span></span>
    <span class="sc3"><span class="re1">&lt;scan</span> <span class="re0">location</span>=<span class="st0">&quot;/coverage/mday/&quot;</span> <span class="re0">suffix</span>=<span class="st0">&quot;.nc&quot;</span><span class="re2">/&gt;</span></span>
  <span class="sc3"><span class="re1">&lt;/aggregation<span class="re2">&gt;</span></span></span>
&#160;
<span class="sc3"><span class="re1">&lt;/netcdf<span class="re2">&gt;</span></span></span></pre></div></div>
<p>First, note that the <i>ncoords</i> attribute should be specified on the individual granules for this version of the module. In many cases the handler will be more efficient if the <i>ncoords</i> attribute is used. Note that we also specify the <i>dimName</i>.  Any data array whose outer dimension is called this will be subject to aggregation in the output. 
</p><p>Serving this from Hyrax will result in the following DDS:
</p>
<div dir="ltr" class="mw-geshi mw-code mw-content-ltr"><div class="c source-c"><pre class="de1">Dataset <span class="br0">&#123;</span>
    Grid <span class="br0">&#123;</span>
      Array<span class="sy0">:</span>
        Float32 PHssta<span class="br0">&#91;</span><span class="kw3">time</span> <span class="sy0">=</span> <span class="nu0">3</span><span class="br0">&#93;</span><span class="br0">&#91;</span>altitude <span class="sy0">=</span> <span class="nu0">1</span><span class="br0">&#93;</span><span class="br0">&#91;</span>lat <span class="sy0">=</span> <span class="nu0">4096</span><span class="br0">&#93;</span><span class="br0">&#91;</span>lon <span class="sy0">=</span> <span class="nu0">8192</span><span class="br0">&#93;</span><span class="sy0">;</span>
      Maps<span class="sy0">:</span>
        Float64 <span class="kw3">time</span><span class="br0">&#91;</span><span class="kw3">time</span> <span class="sy0">=</span> <span class="nu0">3</span><span class="br0">&#93;</span><span class="sy0">;</span>
        Float64 altitude<span class="br0">&#91;</span>altitude <span class="sy0">=</span> <span class="nu0">1</span><span class="br0">&#93;</span><span class="sy0">;</span>
        Float64 lat<span class="br0">&#91;</span>lat <span class="sy0">=</span> <span class="nu0">4096</span><span class="br0">&#93;</span><span class="sy0">;</span>
        Float64 lon<span class="br0">&#91;</span>lon <span class="sy0">=</span> <span class="nu0">8192</span><span class="br0">&#93;</span><span class="sy0">;</span>
    <span class="br0">&#125;</span> PHssta<span class="sy0">;</span>
    Float64 <span class="kw3">time</span><span class="br0">&#91;</span><span class="kw3">time</span> <span class="sy0">=</span> <span class="nu0">3</span><span class="br0">&#93;</span><span class="sy0">;</span>
<span class="br0">&#125;</span> mday_joinExist.<span class="me1">ncml</span><span class="sy0">;</span></pre></div></div>
<p>We see that the time dimension is now of size 3 to match that we joined three granule datasets together.
</p><p>Also notice that the map vector for the joined dimension, time, has been duplicated as a sibling of the dataset.  This is done automatically by the aggregation and it is copied into the actual map of the Grid.  This copy is to facilitate datasets which have multiple Grid's that are to be joined --- the top-level map vector is used as the canonical template map which is then copied into the maps for all the aggregated Grids.  In the case of the joined data being of type Array, this vector would already exist as the coordinate variable for the data matrix.  Since this is the source map for all aggregated Grid's, any attribute (metadata) changes should be made explicitly on this top-level coordinate variable so that the metadata is shared among all the aggregated Grid map vectors.
</p>
<h3><span class="mw-headline" id="Using_the_Scan_Element"><span class="mw-headline-number">2.3</span> Using the Scan Element</span></h3>
<p>The collection of member datasets in a joinExisiting aggregation can be specified using the NcML <i>scan</i> element as described in the  <a href="../index.php/Dynamic_Aggregation_Tutorial" title="Dynamic Aggregation Tutorial"> dynamic aggregation tutorial</a>.
</p>
<h4><span class="mw-headline" id="NcML_Dimension_Cache"><span class="mw-headline-number">2.3.1</span> NcML Dimension Cache</span></h4>
<p>If the scan element is used without the <i>ncoords</i> extension (see below), then the first time a joinExisiting aggregation is accessed (say by requesting it's DDS) the BES process will open <b>every</b> file in the aggregation and cache its dimension information in the NcML dimension cache. By default the cache files are written into <tt>/tmp</tt> and the total size of the cache is limited to a maximum size of 2GB. These settings can be changed by modifying the <tt>ncml.conf file</tt>, typically located in <tt>/etc/bes/modules/ncml.conf</tt>:
</p>
<div dir="ltr" class="mw-geshi mw-code mw-content-ltr"><div class="bash source-bash"><pre class="de1"><span class="co0">#-----------------------------------------------------------------------#</span>
<span class="co0"># NcML Aggregation Dimension Cache Parameters                           #</span>
<span class="co0">#-----------------------------------------------------------------------#</span>
&#160;
<span class="co0"># Directory into which the cache files will be stored.</span>
NCML.DimensionCache.directory=<span class="sy0">/</span>tmp
&#160;
<span class="co0"># Filename prefix to be used for the cache files</span>
NCML.DimensionCache.prefix=ncml_dimension_cache
&#160;
<span class="co0"># This is the size of the cache in megabytes; e.g., 2,000 is a 2GB cache</span>
NCML.DimensionCache.size=<span class="nu0">2000</span>
&#160;
<span class="co0"># Maximum number of dimension allowed in any particular dataset. </span>
<span class="co0"># If not set in this configuration the value defaults to 100.</span>
<span class="co0"># NCML.DimensionCache.maxDimensions=100</span></pre></div></div>
<p>The cache files are small compared to the source dataset files, typically less than 1kb for a dataset with a few named dimensions. However the cache files are numerous, one for each file used in a joinExisiting aggregation. If you have large joinExisiting aggregations it is important to be sure that the <b>NCML.DimensionCache.directory</b> has space to contain the cache and that the <b>NCML.DimensionCache.size</b> to an appropriately large value. 
</p><p>Because the first access of the aggregation triggers the population of the NcML dimension cache for that aggregation the time for this first access can be significant. It may be that typical HTTP clients will timeout before that requests completes. If a client timeout occurs dimension cache may not get fully populated, however subsequent requests will cause the cache population to pick up where it was left off.
</p><p>With only a modicum of effort one could write a shell program that utilizes the BES standalone functionality to pre-populate the dimension caches for large joinExisiting aggregations.
</p>
<h4><span class="mw-headline" id="ncoords_extension"><span class="mw-headline-number">2.3.2</span> ncoords extension</span></h4>
<p>If all of the granules are of uniform dimensional size, we may also use the syntactic sugar provided by a Hyrax-specific extension to NcML -- adding the <i>ncoords</i> attribute to a <b>scan</b> element.   The behavior of this extension is to set the <i>ncoords</i> for each granule matching the scan to be this value, as if the datasets were each listed explicitly with this value of the attribute.  Here's an example of using the syntactic sugar that results in the same exact aggregation as the previous explicit one:
</p>
<pre>
&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;
&lt;!-- joinExisting test on netcdf granules using scan@ncoords extension--&gt;
&lt;netcdf title=&quot;joinExisting test on netcdf Grid granules using scan@ncoords&quot;
	&gt;
  
  &lt;attribute name=&quot;Description&quot; type=&quot;string&quot;
	     value=&quot; joinExisting test on netcdf Grid granules using scan@ncoords&quot;/&gt;

  &lt;aggregation type=&quot;joinExisting&quot; 
	       dimName=&quot;time&quot; &gt;

    &lt;!-- Filenames have lexicographic and chronological ordering match --&gt;
    &lt;scan location=&quot;/coverage/mday&quot;
	  subdirs=&quot;false&quot;
	  suffix=&quot;.nc&quot;
	  ncoords=&quot;1&quot;
	  /&gt;

  &lt;/aggregation&gt;
  
&lt;/netcdf&gt;

</pre>
<p>which we see results in the same DDS:
</p>
<pre>
Dataset {
    Grid {
      Array:
        Float32 PHssta[time = 3][altitude = 1][lat = 4096][lon = 8192];
      Maps:
        Float64 time[time = 3];
        Float64 altitude[altitude = 1];
        Float64 lat[lat = 4096];
        Float64 lon[lon = 8192];
    } PHssta;
    Float64 time[time = 3];
} mday_joinExist.ncml;
</pre>
<p>The advantage of this is that the server does not have to inspect all of the member granules to determine their dimensional size which allows server to manufacture responses much more quickly.
</p>
<h2><span class="mw-headline" id="Limitations"><span class="mw-headline-number">3</span> Limitations</span></h2>
<p>The current version implements only basic functionality.  If there is extended functionality that is needed for your use, please send &lt;<a rel="nofollow" class="external free" href="mailto:support@opendap.org">mailto:support@opendap.org</a>&gt; to let us know!  
</p><p><br />
</p>
<h3><span class="mw-headline" id="Join_Dimension_Sizes_Should_Be_Explicitly_Declared"><span class="mw-headline-number">3.1</span> Join Dimension Sizes Should Be Explicitly Declared</span></h3>
<p>As we have seen, the most important limitation to the JoinExisting aggregation support is that the <i>ncoords</i> attribute should be specified for efficiency reasons.  Future versions will continue to relax this requirement.  The problem is that the size of the output join dimension is dependent on checking the DDS of <i>every</i> granule in the aggregation, which is computationally expensive for large aggregations.
</p>
<h3><span class="mw-headline" id="Source_of_Data_for_Aggregated_Coordinate_Variable_on_Join_Dimension"><span class="mw-headline-number">3.2</span> Source of Data for Aggregated Coordinate Variable on Join Dimension</span></h3>
<p>This version does not allow the join dimension's data to be declared explicitly in the NcML as the NcML tutorial page describes.  This version automatically aggregates <b>all</b> variables with the outer dimension matching the <i>dimName</i>.  This includes the coordinate variable (map vector in the case of Grid's) for the join dimension.  These data cannot be overridden from those pulled from the files.  Currently the TDS lists about 5 ways this data can be specified in addition to pulling them from the granules --- we only can pull them from granules now, which seems the most common use.
</p>
<h3><span class="mw-headline" id="Source_of_Join_Dimension_Metadata"><span class="mw-headline-number">3.3</span> Source of Join Dimension Metadata</span></h3>
<p>The metadata for the coordinate variable is pulled from the <i>first</i> granule dataset.  Modification of coordinate variable metadata is not fully supported yet.
</p><p><br />
</p>
<hr />




</div>
				<!-- end content -->
				<div class="visualClear"></div>
	</div>
</div></div>
</body></html>