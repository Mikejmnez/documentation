
<!DOCTYPE html>
<html lang="en" dir="ltr" class="client-nojs">
<head>
<title>Hyrax - Apache Integration - OPeNDAP Documentation</title>
</head>
<body class="mediawiki ltr sitedir-ltr ns-0 ns-subject page-Hyrax_-_Apache_Integration skin-monobook action-view">
<div id="globalWrapper">
<div id="column-content"><div id="content" class="mw-body-primary" role="main">
	
	
	<h1 id="firstHeading" class="firstHeading" lang="en"><span dir="auto">Hyrax - Apache Integration</span></h1>
	<div id="bodyContent" class="mw-body">
		<div id="siteSub">From OPeNDAP Documentation</div>
		<div id="contentSub"></div>
		

		<!-- start content -->
<div id="mw-content-text" lang="en" dir="ltr" class="mw-content-ltr"><div id="toc" class="toc"><div id="toctitle"><h2>Contents</h2></div>
<ul>
<li class="toclevel-1 tocsection-1"><a href="#Overview"><span class="tocnumber">1</span> <span class="toctext">Overview</span></a></li>
<li class="toclevel-1 tocsection-2"><a href="#Prerequisites"><span class="tocnumber">2</span> <span class="toctext">Prerequisites</span></a></li>
<li class="toclevel-1 tocsection-3"><a href="#Connecting_Tomcat_to_Apache"><span class="tocnumber">3</span> <span class="toctext">Connecting Tomcat to Apache</span></a>
<ul>
<li class="toclevel-2 tocsection-4"><a href="#Tomcat"><span class="tocnumber">3.1</span> <span class="toctext">Tomcat</span></a></li>
<li class="toclevel-2 tocsection-5"><a href="#Apache"><span class="tocnumber">3.2</span> <span class="toctext">Apache</span></a></li>
<li class="toclevel-2 tocsection-6"><a href="#How_It_Works"><span class="tocnumber">3.3</span> <span class="toctext">How It Works</span></a></li>
</ul>
</li>
<li class="toclevel-1 tocsection-7"><a href="#Apache_Compressed_Responses"><span class="tocnumber">4</span> <span class="toctext">Apache Compressed Responses</span></a>
<ul>
<li class="toclevel-2 tocsection-8"><a href="#httpd.conf"><span class="tocnumber">4.1</span> <span class="toctext">httpd.conf</span></a></li>
</ul>
</li>
<li class="toclevel-1 tocsection-9"><a href="#Apache_Authentication"><span class="tocnumber">5</span> <span class="toctext">Apache Authentication</span></a></li>
</ul>
</div>

<h2><span class="mw-headline" id="Overview"><span class="mw-headline-number">1</span> Overview</span></h2>
<p>The problem of linking Tomcat with Apache has been greatly reduced as of Apache 2.2. In previous incarnations of Apache &amp; Tomcat, it was fairly complex. To see how to solve the problem for older versions of Apace, see the <a href="../index.php/Old_Apache_Integration_instructions" title="Old Apache Integration instructions">old Apache Integration instructions</a>. What follows are the instructions for Apache 2.2 and Tomcat 6.x.
</p>
<h2><span class="mw-headline" id="Prerequisites"><span class="mw-headline-number">2</span> Prerequisites</span></h2>
<ul>
<li> Apace 2.2 or greater
</li>
<li> Tomcat 6.x or greater
</li>
<li> mod_proxy_ajp installed in Apache (typically this is present in 2.2+)
</li>
</ul>
<h2><span class="mw-headline" id="Connecting_Tomcat_to_Apache"><span class="mw-headline-number">3</span> Connecting Tomcat to Apache</span></h2>
<h3><span class="mw-headline" id="Tomcat"><span class="mw-headline-number">3.1</span> Tomcat</span></h3>
<p>You have to create the AJP connector in the <i>conf/server.xml</i> file:
</p><p><br />
</p>
<div dir="ltr" class="mw-geshi mw-code mw-content-ltr"><div class="xml source-xml"><pre class="de1">    <span class="sc-1">&lt;!-- Define an AJP 1.3 Connector on port 8009 --&gt;</span>
    <span class="sc3"><span class="re1">&lt;Connector</span> </span>
<span class="sc3">        <span class="re0">port</span>=<span class="st0">&quot;8009&quot;</span> </span>
<span class="sc3">        <span class="re0">protocol</span>=<span class="st0">&quot;AJP/1.3&quot;</span> </span>
<span class="sc3">        <span class="re0">redirectPort</span>=<span class="st0">&quot;443&quot;</span> &lt;!-- Redirect to the Apache Web Server secure port --<span class="re2">&gt;</span></span>
        scheme=&quot;https&quot; <span class="sc-1">&lt;!-- Use TLS to connect --&gt;</span>
        address=&quot;127.0.0.1&quot; <span class="sc-1">&lt;!-- Only allow connections from this host --&gt;</span>
        <span class="sc-1">&lt;!-- Setting tomcatAuthentication to 'false' will allow tomcat web applications </span>
<span class="sc-1">                to get user session information from Apache, such as uid and other user properties. --&gt;</span>
        tomcatAuthentication=&quot;true&quot; 
        /&gt;</pre></div></div>
<p>This line will enable AJP connections to the 8009 port of your tomcat server (localhost for example).
</p>
<h3><span class="mw-headline" id="Apache"><span class="mw-headline-number">3.2</span> Apache</span></h3>
<p>In the example below, pay special attention to the <i>protocol</i> part of the proxy URL - it uses <b>ajp://</b> and not 'http://'.<br />
Add this to Apache's <i>httpd.conf</i> file:
</p>
<div dir="ltr" class="mw-geshi mw-code mw-content-ltr"><div class="apache source-apache"><pre class="de1">&lt;<span class="kw3">Proxy</span> *&gt;
    <span class="kw1">AddDefaultCharset</span> <span class="kw2">Off</span>
    <span class="kw1">Order</span> <span class="kw1">deny</span>,<span class="kw1">allow</span>
    <span class="kw1">Allow</span> from <span class="kw2">all</span>
&lt;/<span class="kw3">Proxy</span>&gt;
&#160;
<span class="kw1">ProxyPass</span> /opendap ajp://localhost:<span class="nu0">8009</span>/opendap
<span class="kw1">ProxyPassReverse</span> /opendap ajp://localhost:<span class="nu0">8009</span>/opendap</pre></div></div>
<p>NB: It's possible to embed these in a <i>VirtualHost</i> directive.
</p>
<h3><span class="mw-headline" id="How_It_Works"><span class="mw-headline-number">3.3</span> How It Works</span></h3>
<p>ProxyPass and ProxyPassReverse are classic reverse proxy directives used to forward the stream to another location.
<i>ajp://...</i> is the AJP connector location (your tomcat's server host/port)
</p><p>A web client will connect through HTTP to <i>http://localhost/</i> (supposing your apache2 server is running on localhost), the <i>mod_proxy_ajp</i> will forward you request transparently using the AJP protocol to the tomcat application server on localhost:8009.
</p>
<h2><span class="mw-headline" id="Apache_Compressed_Responses"><span class="mw-headline-number">4</span> Apache Compressed Responses</span></h2>
<p>Many OPeNDAP clients accept compressed responses. This can greatly increase the efficiency of the client/server interaction by diminishing the number of bytes actually transmitted over "the wire". Compression can reduce the number of bytes transmitted by an order of magnitude for many datasets!
</p><p>Tomcat provides native compression support for the GZIP compression mechanism, however it is NOT turned on by default. More perversely, even if you have configured Tomcat to provide compressed responses, if you are using AJP to proxy Tomcat through the Apache web server compression will not be enabled unless you configure the Apache web server to compress responses. This is because Tomcat NEVER compresses responses sent over AJP.
</p><p>When you configure your Apache web server to provide compressed responses you will probably want to make sure that Apache doesn't apply compression to images (In general images are already compressed and there is little to gain by attempting to compress them and a lot of CPU cycles to burn if you try)
</p><p><a rel="nofollow" class="external text" href="http://httpd.apache.org/docs/2.0/mod/mod_deflate.html">Apache compression module</a>
</p><p><a rel="nofollow" class="external text" href="http://www.askapache.com/htaccess/apache-speed-compression.html">AskApache Speed Tips</a>
</p><p><a rel="nofollow" class="external text" href="http://betterexplained.com/articles/how-to-optimize-your-site-with-gzip-compression/">BetterExplained explains Apache Compression</a>
</p>
<h3><span class="mw-headline" id="httpd.conf"><span class="mw-headline-number">4.1</span> httpd.conf</span></h3>
<p>You will need to add (something like) the following to your Apache web server's httpd.conf file:
</p>
<div dir="ltr" class="mw-geshi mw-code mw-content-ltr"><div class="apache source-apache"><pre class="de1"><span class="co1">#</span>
<span class="co1"># Compress everything except images.</span>
<span class="co1">#</span>
&lt;<span class="kw3">Location</span> /&gt;
    <span class="co1"># Insert filter</span>
    <span class="kw1">SetOutputFilter</span> DEFLATE
&#160;
    <span class="co1"># Netscape 4.x has some problems...</span>
    <span class="kw1">BrowserMatch</span> ^Mozilla/<span class="nu0">4</span> gzip-only-text/html
&#160;
    <span class="co1"># Netscape 4.06-4.08 have some more problems</span>
    <span class="kw1">BrowserMatch</span> ^Mozilla/<span class="nu0">4</span>\.0[<span class="nu0">678</span>] no-gzip
&#160;
    <span class="co1"># MSIE masquerades as Netscape, but it is fine</span>
    <span class="co1"># BrowserMatch \bMSIE&#160;!no-gzip&#160;!gzip-only-text/html</span>
&#160;
    <span class="co1"># NOTE: Due to a bug in mod_setenvif up to Apache 2.0.48</span>
    <span class="co1"># the above regex won't work. You can use the following</span>
    <span class="co1"># workaround to get the desired effect:</span>
    <span class="kw1">BrowserMatch</span> \bMSI[E]&#160;!no-gzip&#160;!gzip-only-text/html
&#160;
    <span class="co1"># Don't compress images</span>
    <span class="kw1">SetEnvIfNoCase</span> Request_URI \
    \.(?:gif|jpe?g|png)$ no-gzip dont-vary
&#160;
    <span class="co1"># Make sure proxies don't deliver the wrong content</span>
    <span class="kw1">Header</span> append Vary User-Agent env=!dont-vary
&lt;/<span class="kw3">Location</span>&gt;</pre></div></div>
<p>&lt;/font&gt;
</p>
<h2><span class="mw-headline" id="Apache_Authentication"><span class="mw-headline-number">5</span> Apache Authentication</span></h2>
<p>Hyrax may deployed into service stacks in which <i>httpd</i> is expected to handle the work of authenticating users. In order for Tomcat (and thus Hyrax) to be able to receive the users login name and attributes from <i>httpd</i> the following things need to be done to the Tomcat configuration.
</p><p>In the <i>$CATALINA_HOME/conf/server.xml</i>  file the default definition of the AJP connector typically looks like:
</p>
<div dir="ltr" class="mw-geshi mw-code mw-content-ltr"><div class="xml source-xml"><pre class="de1">    <span class="sc-1">&lt;!-- Define an AJP 1.3 Connector on port 8009 --&gt;</span>
    <span class="sc3"><span class="re1">&lt;Connector</span> <span class="re0">port</span>=<span class="st0">&quot;8009&quot;</span> <span class="re0">protocol</span>=<span class="st0">&quot;AJP/1.3&quot;</span> <span class="re0">redirectPort</span>=<span class="st0">&quot;8443&quot;</span> <span class="re2">/&gt;</span></span></pre></div></div>
<p>This line may be "commented out," with &lt;!-- on a line before and --&gt; on a line after. If so, remove those lines. If you cannot find the AJP connector element, simply create it from the code above. You will need to add several attributes to the Connector element.
</p>
<ul>
<li> Set the <code>tomcatAuthentication</code> attribute to "false", this must be done in order to receive authentication information from Apache.
</li>
<li> Configure the connector to use SSL - If your Apache web server is using SSL/HTTPS (and it should be), you need to tell Tomcat about that fact so that it can construct internal URLs correctly. 
<ul>
<li> Set the <code>scheme</code> attribute to "https".
</li>
<li> Set the <code>proxyPort</code> attribute to Apache httpd's secure socket, typically "443" (This ensures that secure traffic gets routed through Apache httpd and and then through the AJP connector to Tomcat, allowing httpd's authentication/authorization stack to be invoked on the request).
</li>
</ul>
</li>
<li> Restrict access to the AJP Connector. By disabling access to the connector from anywhere but the local system you prevent system probing from the greater world. To do this, set the <code>address</code> attribute to "127.0.0.1".
</li>
</ul>
<p>When you are finished making changes, your connector should look something like this:
</p>
<div dir="ltr" class="mw-geshi mw-code mw-content-ltr"><div class="xml source-xml"><pre class="de1">    <span class="sc-1">&lt;!-- Define an AJP 1.3 Connector on port 8009 --&gt;</span>
    <span class="sc3"><span class="re1">&lt;Connector</span> </span>
<span class="sc3">        <span class="re0">port</span>=<span class="st0">&quot;8009&quot;</span> </span>
<span class="sc3">        <span class="re0">protocol</span>=<span class="st0">&quot;AJP/1.3&quot;</span> </span>
<span class="sc3">        <span class="re0">redirectPort</span>=<span class="st0">&quot;443&quot;</span> </span>
<span class="sc3">        <span class="re0">scheme</span>=<span class="st0">&quot;https&quot;</span></span>
<span class="sc3">        <span class="re0">address</span>=<span class="st0">&quot;127.0.0.1&quot;</span> </span>
<span class="sc3">        <span class="re0">tomcatAuthentication</span>=<span class="st0">&quot;false&quot;</span> </span>
<span class="sc3">        <span class="re2">/&gt;</span></span></pre></div></div>
<p>Restart Tomcat to load the new configuration. Now Tomcat/Hyrax should see all of the authentication attributes from <i>httpd</i>. 
</p><p>NB: You may wish review Tomcat documentation for the AJP Connector as there many attributes/options that can be used to tune performance. <a rel="nofollow" class="external text" href="http://tomcat.apache.org/tomcat-7.0-doc/config/ajp.html">Here's a link to the Tomcat 7 AJP Connector docs</a>
</p>



</div>
				<!-- end content -->
				<div class="visualClear"></div>
	</div>
</div></div>
</body></html>