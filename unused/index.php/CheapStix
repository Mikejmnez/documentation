
<!DOCTYPE html>
<html lang="en" dir="ltr" class="client-nojs">
<head>
<title>CheapStix - OPeNDAP Documentation</title>
</head>
<body class="mediawiki ltr sitedir-ltr ns-0 ns-subject page-CheapStix skin-monobook action-view">
<div id="globalWrapper">
<div id="column-content"><div id="content" class="mw-body-primary" role="main">
	
	
	<h1 id="firstHeading" class="firstHeading" lang="en"><span dir="auto">CheapStix</span></h1>
	<div id="bodyContent" class="mw-body">
		<div id="siteSub">From OPeNDAP Documentation</div>
		<div id="contentSub"></div>
		

		<!-- start content -->
<div id="mw-content-text" lang="en" dir="ltr" class="mw-content-ltr"><p>CheapStix is a small project to build a VM using Ubuntu on VMware to deliver Hyrax. The VM will be copied onto cheap memory sticks and given out. It would be great if the stuff was ready for the ESDSWG meeting which starts on 21 Oct. 2008. This project was funded by NASA.
</p><p><i><b>See also: <a href="../index.php/Using_Virtual_Machines_to_Serve_Data" title="Using Virtual Machines to Serve Data">Using Virtual Machines to Serve Data</a></b></i>
</p><p>Steps:
</p>
<ol>
<li> Find out a place to get memory sticks at a decent price
<ol>
<li> How much/many? ~$11.50ea for 100 @ 2GB
</li>
<li> With a logo? + 0.99ea for each color after two 
</li>
</ol>
</li>
</ol>
<dl>
<dd><dl>
<dd><dl>
<dd>Sent in for quotes from usb-depot.com (Styles: London and Chicago look good). Cost is ~$11.50ea plus 0.99ea for each color more than two if we get 100 2GB sticks. Lead-time of about a week
</dd>
<dd>What about <a rel="nofollow" class="external text" href="http://www.usb-depot.com/usb/chicago.shtml">Chicago</a> in Red or <a rel="nofollow" class="external text" href="http://www.usb-depot.com/usb/london.shtml">London</a> in Silver?
</dd>
<dd>Also requested quote from usb-flashdrive.com
</dd>
<dd>Other sources: customusb.com
</dd>
</dl>
</dd>
</dl>
</dd>
</dl>
<ol>
<li> Build the VM
<ol>
<li> Special dist of Ubuntu or not
<ol>
<li>Ubuntu: Gets us experience with debian packages and maybe support for building them in Makefiles
</li>
<li>Cento gets us something we can use on our rented VMs, maybe
</li>
</ol>
</li>
<li> VMware virtual appliance?
</li>
</ol>
</li>
</ol>
<hr />
<div id="toc" class="toc"><div id="toctitle"><h2>Contents</h2></div>
<ul>
<li class="toclevel-1 tocsection-1"><a href="#Update"><span class="tocnumber">1</span> <span class="toctext">Update</span></a></li>
<li class="toclevel-1 tocsection-2"><a href="#Building_the_VMs"><span class="tocnumber">2</span> <span class="toctext">Building the VMs</span></a>
<ul>
<li class="toclevel-2 tocsection-3"><a href="#Load_a_development_environment_and_build_.26_test_Hyrax"><span class="tocnumber">2.1</span> <span class="toctext">Load a development environment and build &amp; test Hyrax</span></a></li>
<li class="toclevel-2 tocsection-4"><a href="#Shrink_the_JeOS_VM"><span class="tocnumber">2.2</span> <span class="toctext">Shrink the JeOS VM</span></a>
<ul>
<li class="toclevel-3 tocsection-5"><a href="#The_udev_hack"><span class="tocnumber">2.2.1</span> <span class="toctext">The udev hack</span></a></li>
</ul>
</li>
<li class="toclevel-2 tocsection-6"><a href="#Package_the_VM_for_distribution"><span class="tocnumber">2.3</span> <span class="toctext">Package the VM for distribution</span></a>
<ul>
<li class="toclevel-3 tocsection-7"><a href="#Last_steps"><span class="tocnumber">2.3.1</span> <span class="toctext">Last steps</span></a></li>
</ul>
</li>
</ul>
</li>
<li class="toclevel-1 tocsection-8"><a href="#Running_the_VM"><span class="tocnumber">3</span> <span class="toctext">Running the VM</span></a>
<ul>
<li class="toclevel-2 tocsection-9"><a href="#Data_Access"><span class="tocnumber">3.1</span> <span class="toctext">Data Access</span></a></li>
<li class="toclevel-2 tocsection-10"><a href="#Network_Access"><span class="tocnumber">3.2</span> <span class="toctext">Network Access</span></a></li>
</ul>
</li>
</ul>
</div>

<h2><span class="mw-headline" id="Update"><span class="mw-headline-number">1</span> Update</span></h2>
<div class="floatright"><a href="../index.php/File:Memory_stick_2.png" class="image" title="The Thumb Drive"><img alt="The Thumb Drive" src="../images/thumb/1/14/Memory_stick_2.png/200px-Memory_stick_2.png" width="200" height="70" srcset="/images/thumb/1/14/Memory_stick_2.png/300px-Memory_stick_2.png 1.5x, /images/thumb/1/14/Memory_stick_2.png/400px-Memory_stick_2.png 2x" /></a></div>
<p><b>29 Oct 2008</b> The project was completed on the 17th in time for the meeting and we presented a poster on the idea there.
</p><p>I used usb-flashdrive.com and ordered 100 2GB <i>Twister 1</i> drives in Blue with a two-color logo. Cost, including shipping was $10.25 ea. I've checked the logo (which is a vector graphics file, .ai) into the SVN <i>graphics</i> project.
</p>
<h2><span class="mw-headline" id="Building_the_VMs"><span class="mw-headline-number">2</span> Building the VMs</span></h2>
<p>I built two VMs, both using Ubuntu 8.04 (Hardy). The first one uses the JeOS distribution of Hardy and does not contain a build environment or a GUI in its distribution form while the second does contain both of those things. However, I built the server binaries using a third version of the VM - JeOS with a build environment.
</p><p>While doing this, make liberal use of the 'snapshot' feature of WS. I mention how I used it to go 'back in time' to a smaller VM, but I actually used it much more than to make just one snapshot (see the picture at below at right).
</p><p>There is also a bug somewhere in Ubuntu and/or VMware involving network persistence. There's a subsection below on a fix for that.
</p>
<h3><span class="mw-headline" id="Load_a_development_environment_and_build_.26_test_Hyrax"><span class="mw-headline-number">2.1</span> Load a development environment and build &amp; test Hyrax</span></h3>
<p>Here's the procedure:
</p>
<ol>
<li> Get VMware Workstation - I did all of the work in Workstation since it's much easier to build and fiddle with the VM in Workstation than server and the two are mutually exclusive.
</li>
<li> Download the ISO for JeOS - I got this from the main Ubuntu site.
</li>
<li> Crank up VM Workstation, make a new VM and tie the ISO image to the CDROM drive using the VM's configuration options. Also, turn on shared folders since they simplify transfer of stuff between the VM and the host.
</li>
<li> Boot the VM - There's an option to create an initial user. I used <i>jimg</i> and then had to hassle to change it to <i>opendap</i> later. Either way, it's set to use sudo and you do most of this as root (i.e., <i>sudo su</i>)
</li>
<li> Install VMware tools - Use the menu in Workstation (WS) and then in the VM as root:
</li>
</ol>
<pre>cp -a /media/cdrom0/VMwareTools*.gz /tmp
cd /tmp
tar -xzf VMwareTools*.gz
cd vmware-tools-distrib
./vmware-install.pl
</pre>
<ol>
<li> Make a snapshot of the VM at this point so we can come back to this state (before we load up the VM with the development tools) later.<div class="thumb tright"><div class="thumbinner" style="width:182px;"><a href="../index.php/File:VM_snapshots.png" class="image"><img alt="" src="../images/thumb/2/2f/VM_snapshots.png/180px-VM_snapshots.png" width="180" height="98" class="thumbimage" srcset="/images/thumb/2/2f/VM_snapshots.png/270px-VM_snapshots.png 1.5x, /images/thumb/2/2f/VM_snapshots.png/360px-VM_snapshots.png 2x" /></a>  <div class="thumbcaption"><div class="magnify"><a href="../index.php/File:VM_snapshots.png" class="internal" title="Enlarge"><img src="../skins/common/images/magnify-clip.png" width="15" height="11" alt="" /></a></div>Snapshots of the VM during various stages of development</div></div></div>
</li>
<li> Now use <i>apt-get</i> to install stuff we need to build the server (i.e., <i>sudo apt-get install &lt;package&gt;</i>)
<ol>
<li> build-essential
</li>
<li> libcurl3, curl, libcurl4-openssl-dev - I may have used libcurl3-dev and not needed curl...
</li>
<li> libxml2-dev
</li>
<li> subversion, autoconf, automake, libtool, flex, bison - probably not needed if you use the tar.gz distributions
</li>
<li> wget (curl works too, but I like wget)
</li>
<li> libreadline-dev
</li>
<li> libnetcdf-dev, libhdf4g-dev, libhdf5-serial-dev
</li>
<li> sun-java6-jre - this you need to run tomcat. Don't use apt-get to get tomcat 5.5; I describe how to get Tomcat 6 later on.
</li>
</ol>
</li>
<li> Use subversion to get the Hyrax server software (or use the tar.gz dists from the web page)
</li>
<li> Build the BES:
<ol>
<li> libdap 3.8.2 - configure using prefix (I built it in my own directory once and then again in /opt/Hyrax-1.4.2 which is where the code is on the distributions). Once built, add $prefix/bin to PATH and always use --prefix with configure.
</li>
<li> BES 3.6.2
</li>
<li> dap-server 3.8.5, netcdf_handler 3.7.9, hdf4_h 3.7.9, freeform 3.7.9, hdf5 1.2.3 - use <i>make install</i> and <i>make bes-conf</i>
</li>
<li> Add <i>bes</i> user and group (vi /etc/group and then <i>useradd -g bes -d /dev/null -s /bin/false bes</i>)
</li>
<li> Edited <i>bes.conf</i> to user the bes user/group. I added (mkdir) /opt/Hyrax-1.4.2/log and set the log file to /opt/Hyrax*/log/bes.log)
</li>
<li> chmod/grp bes /opt/Hyrax-1.4.2/ - so the log file works and may otherwise be needed.
</li>
<li> <b>Worked</b> That is, the BES starts and I can talk to it with <i>bescmdln</i>
</li>
</ol>
</li>
<li> Get Tomcat - the tomcat 5.5 code available from apt-get is hosed. Instead, download tomcat from Apace (<i>wget .../apache-tomcat-6.0.18.tar.gz</i>)
</li>
<li> Unpack Tomcat in /opt - I made a sym link from /opt/tomcat to /opt/apache-tomcat-...
</li>
<li> Get the OLFS 1.4.2 webapp.jar from the web page, open and cp the opendap.war in /opt/apache-tomcat-.../webapps
</li>
<li> Start Tomcat - You need to set JAVA_HOME for this to work (<i>export JAVA_HOME=/usr/lib/jvm/java-6-sun</i>)
</li>
<li> <b>Worked</b> Given that the BES was already running and the <i>make bes-conf</i> targets installed sample data and modified the <i>bes.conf</i> file to match.
</li>
</ol>
<h3><span class="mw-headline" id="Shrink_the_JeOS_VM"><span class="mw-headline-number">2.2</span> Shrink the JeOS VM</span></h3>
<p>There is a trick I used to get the JeOS VM small: Load development packages to build the server, then go back to a snapshot before anything was loaded except VMware Tools and load only those runtime (not development) packages needed. For example, the dist VM uses libnetcdf4 instead of libnetcdf4-dev which was needed to build the server.
</p>
<ol>
<li> Run <i>make clean</i> in the Hyrax source dirs or remove the source.
</li>
<li> Use tar to package the binary build - the entire /opt/Hyrax-1.4.2 tree
</li>
<li> Copy to the shared folder directory to put that tar on the host OS - the shared folder directory mounts under /mnt when VMware Tools is running.
</li>
<li> Now, shut down the VM and revert to the earlier snapshot where VMware tools had just been installed but nothing else was done. I did this by copying the VM directory on the host and then using the revert option in WS, but I think the copy was not really necessary so long as you take snapshots of any state to which you want to return.
</li>
<li> Boot the <i>snapshot2</i> VM
</li>
<li> Copy the tar file from the shared folder to /opt and expand.
</li>
<li> Add /opt/Hyrax-1.4.2/bin to PATH
</li>
<li> Use <i>apt-get</i> to add <i>libcurl3</i> and <i>libxml2</i>
</li>
<li> Now the client <i>getdap</i> (which was built/installed as part of the libdap build) works
</li>
<li> Starting The BES
<ol>
<li> added the <i>bes</i> user: Use <i>vi</i> to add the <i>bes</i> group to <i>/etc/group</i>, then <i>useradd -g bes -d /dev/null -s /bin/false bes</i>
</li>
<li> apt-get libhdf4g, libhdf5-serial-1.6.5-0 libnetcdf4
</li>
<li> BES worked - start and then test with <i>bescmdln</i>
</li>
</ol>
</li>
<li> Get Tomcat working
<ol>
<li> apt-get sun-java6-jre
</li>
<li> Get tomcat 6.0.18.tar.gz (using wget)
</li>
<li> Expand that tar.gz file in /opt. I Made a symlink from /opt/tomcat to /opt/apache...
</li>
<li> Set JAVA_HOME to /var/lib/jvm/java-6-sun (note that it's not exactly the same as the package name)
</li>
<li> Copy <i>opendap.war</i> to tomcat's webapps
</li>
<li> Set CATALINA_HOME to /opt/tomcat - I don't know if this was necessary
</li>
<li> Start tomcat (assuming the BES is still running from before)
</li>
<li> Test with getdap
</li>
</ol>
</li>
<li> Hyrax works
</li>
</ol>
<p>Now we have a small VM with a working Hyrax and only the packages needed to run the code - take a snapshot.
</p>
<h4><span class="mw-headline" id="The_udev_hack"><span class="mw-headline-number">2.2.1</span> The udev hack</span></h4>
<p>I found that sometimes the VM would start in WS with networking broken. I don't see a pattern, but looking at the network devices using <i>ifconfig -a</i>, eth0 is hosed (it does not say 'UP'). to fix, cd to /etc/udev and the file <i>70-persistent-net-rules</i> to remove the line about eth0 and edit the line for eth1 replacing 'eth1' with 'eth0'. Restart udev and networking using the eponymous scripts in /etc/init.d. Now ifconfig should show eth0 as 'UP'
</p>
<h3><span class="mw-headline" id="Package_the_VM_for_distribution"><span class="mw-headline-number">2.3</span> Package the VM for distribution</span></h3>
<p>Now set the VM so that the image will prompt the first person to start it for a password. Since we're distributing the VM with a known username and password, this provides some assurance that the password really will be changed. This is also a good time to make permanent the changes to PATH and JAVA_HOME. Lastly, really shrink the VM.
</p><p>Edit /etc/bash.bashrc so that it calls /opt/initial-config unless that has already been called (use a semaphore file)
</p>
<pre>
export JAVA_HOME=/usr/lib/jvm/java-6-sun
export CATALINA_HOME=/opt/tomcat
export hyrax_prefix=/opt/Hyrax-1.4.2
export PATH=$hyrax_prefix/bin:$PATH

if [&#160;! -e /etc/opt/initial-config-run ]; then
    /opt/init/initial-config.sh
    sudo touch /etc/opt/initial-config-run
fi
</pre>
<p>I added the environment variable stuff here, too.
</p><p>Here's the shell script it runs:
</p>
<pre>
#!/bin/sh
#

# Let's change the user's password
echo &quot;Thank you for using the OPeNDAP Hyrax appliance&quot;
echo &quot;For the security of the appliance, we need you to change this user passwor
d now.&quot;
passwd

# You can add here any first user login actions that you require
</pre>
<p>Since the <i>opendap</i> user can run sudo, we could use <i>sudo passwd opendap</i> in place of <i>passwd</i>. The former would be slicker since the initial user would not be asked to type their password (which they have just entered and is well known) to then change their password. 
</p>
<h4><span class="mw-headline" id="Last_steps"><span class="mw-headline-number">2.3.1</span> Last steps</span></h4>
<p>Remove anything that smacks of <i>ssh</i>. This means that if any ssh packages were loaded, remove them using <i>apt-get --purge remove</i> and also look for <i>.ssh</i> directories in login accounts. It's important to not distribute VMs with this stuff...
</p><p>Now, shrink the disk files - to get the VM to fit in the smallest space without using compression, we need to do the following: Zero fill the disks (files, really) and then use a VMware tool to 'shrink' them. As root:
</p>
<pre>
cat /dev/zero &gt; zero.fill
sync
sleep 1
sync
rm -f zero.fill
</pre>
<p>Stop the VM (shutdown) and in the host OS run <i>vmware-vdiskmanager -k &lt;disk file master&gt;</i> (there are likely a bunch of 'vmdk' files, the 'master' file is named something like <i>Ubuntu JeOS-000008-cl1.vmdk</i> and is relatively small. Ignore the ones name ...s001.vmdk.
</p><p>I used zip to compress the resulting VM (which is a directory). I could not figure out how to run zip from the command line, but Fedora/Gnome has a decent 'Create Archive...' option. I chose zip because I know windows users have it.
</p>
<h2><span class="mw-headline" id="Running_the_VM"><span class="mw-headline-number">3</span> Running the VM</span></h2>
<p>Use VM server to run the VM.
</p>
<h3><span class="mw-headline" id="Data_Access"><span class="mw-headline-number">3.1</span> Data Access</span></h3>
<p>To access data, the VM will need to either have a copy of the data on its local disk or use a network share. Let's assume the latter.
</p><p>On the host OS, export the share using NFS or Samba. It's a good idea to export the share as read-only. On the VM use apt-get to add samba or nfs and configure it to mount the remote share. Edit /opt/Hyrax-1.4.2/etc/bes/bes.conf so that it uses the remote share as the DataRoot directory.
</p>
<h3><span class="mw-headline" id="Network_Access"><span class="mw-headline-number">3.2</span> Network Access</span></h3>
<p>NB: I made these changes to the RSS copy of the VM only. <a href="../index.php/User:Jimg" title="User:Jimg">jimg</a> 09:59, 12 February 2009 (PST)
</p><p>VMware Server has extensive documentation on this topic.
</p><p>The current VM built with Ubuntu JeOS uses Bridged networking and a static IP, based on work/feedback from Marty Brewer at RSS, Inc. The static IP number is 192.168.0.100 and the DNS servers are set to the servers provided by the OpenDNS project. You may be able to use it as is. However, here are the files you need to edit to change these settings:
</p><p>In /etc/network/interfaces change the IP number. Here's what the file looks like now:
</p>
<pre>
# This file describes the network interfaces available on your system
# and how to activate them. For more information, see interfaces(5).

# The loopback network interface
auto lo
iface lo inet loopback

# This is a list of hotpluggable network interfaces.
# They will be activated automatically by the hotplug subsystem.
mapping hotplug
        script grep
        map eth0

# The primary network interface
auto eth0
iface eth0 inet static
        address 192.168.0.100
        netmask 255.255.255.0
        network 192.168.0.0
        broadcast 192.168.0.255
        gateway 192.168.0.1
</pre>
<p>In /etc/resolv.conf change the IP numbers of the two <i>nameserver</i> lines to local names servers if you don't want to use the OpenDNS servers.
</p><p>The VM supports both bridged and NAT networking options and you can switch between these modes in the VMware Server Settings dialog.
</p>



</div>
				<!-- end content -->
				<div class="visualClear"></div>
	</div>
</div></div>
</body></html>