= Hyrax WCS Service
:James Gallagher <jgallagher@opendap.org>:
{docdate}
:numbered:
:toc:

== Overview

Hyrax includes an optional WCS-2 service (spcificlly version 2.0.1)
that can be used to
access all of the geo-referenced data available to the server that
meet the requirements of the WCS 2 specification. This appendix
describes the the kinds of data that meet these requirements along
with the installation and configuration process of the optional WCS
service. 

== Hyrax Integration

The integration of the WCS service into Hyrax is similar to that of the
xref:WMS_Service[WMS service] described elsewhere in this manual in that it
employs the concept of a DynamicService.

*WCS DynamicService*: A WCS DynamicService creates an association between a
URL path prefix in the WCS service path, and these crucial things:

- A simple coverage template for a particular file or collection of files
with similar domain coordinate characteristics.
- The URL of either a DAP server from which to get the data, or a BES
protocol reference (``bes://``) that tells the WCS engine that a direct
BES connection should be used to service the requests.
- If a BES protocol reference is provided then the rest of the href value
must be a regular expression which is applied to the dataset file
path in the server. At runtime when Hyrax uses the regex to determine if
a particular dataset should getWCS service links in it's _viewers_ page
and in its THREDDS catalog reference.

The DynamicService instances are defined in the wcs_service.xml file.

In this WCS implementation there is no separate comprehensive
WCS service with a catalog containing all of the coverages that might
be found in the server. Instead, the Hyrax catalogs' _viewers_ pages are
used to access the WCS service interface for a particular dataset.
From a programmatic access perspective the WCS endpoint URLs are easily
constructed and appear as service links associated with datasets in
the THREDDS catalogs generated by the server.

``Because the links used to access the WCS service are incorporated into
the web pages provided by Hyrax, the ability to easily reference data
from other servers is not made available in the software we provide
(although it the service could be configured that way if a new catalog
system were added).``

``This can be accomplished using either HTTP to work
with a remote DAP server, or the service can directly utilize the BES
as configured for a local Hyrax.
``

== Theory of Operation

The WCS utilizes a DAP server (e.g., a Hyrax server) to supply both
coverage metadata and binary data responses to service client WCS
requests.

In this operational model, each a DAP Dataset is considered a
(potential) WCS Coverage and the variables within a Dataset are
(potential) WCS Coverage Field entities.

The WCS service attempts to dynamically map DAP datasets to WCS
Coverages so that the data provider need not learn all of the details
of the WCS specifications. At minimum the data provider will need to
provide a simple template for each "collection" of related
dataset/coverages. The amount of detail required in a template is
a function of the metadata available within a specific datatset..

The template, called a DynamicService, provides the
domain coordinate details (Latitdue, Longitude, etc) for a group of
coverages and depending on available metadata may also need to provide
field/variable definitions. The template uses a regular expression to
create the association between the DynamicService definition (and its
coverage model) and specific files or collections of files in the DAP
server.


== WCS Versions Supported

The Open Geospatial Consortium
(link:http://www.opengeospatial.org/[OGC]) has developed the Web
Coverage Service (WCS) as an open specification. In practice, there
are a suite of standards documents that describe different aspects of
the service, and we support several beyond the basic WCS 2.0 core specification.

TIP: The _Open Geospatial Consortium_ has many documents that describe
the concept of a _coverage_ and the different features of WCS. The
link:http://www.opengeospatial.org/standards/wcs[suite of
specifications that describe WCS] can be found on their website.

The WCS service bundled with Hyrax 1.14 supports the following WCS
specifications:

* WCS Core Interface Core, version 2.0.1
* Coverage Implementation Schema (CIS), version 1.0.1
* Range Subsetting, version 1.0.0
* KVP Protocol Binding, version 1.0.1


* GeoTIFF Coverage Encoding Profile, version 1.0.1
* JPEG2000 Coverage Encoding Profile, version 1.0.0
* CF-netCDF 3.0 encoding using GML Coverage Application Schema,
  version 2.0

We have partial implementations for:

* XML/POST protocol Binding Extension, version 1.0.0
* XML/SOAP Protocol Binding Extension, version 1.0.0
* Scaling Extension, version 1.0.0
* CRS Extension, version1.0.0

If you are interested in the _Earth Observation Application Profile_,
version 1.0.0, contact us.

== Candidate Datasets

In order for the WCS service to work with a dataset served using DAP,
that dataset must contain one or more _coverages_, dataset variables
that meet fairly strict requirements for both structure and metadata.
To qualify as a WCS coverage, a variable in a dataset must satisfy the
following criteria:

* The variable must have an associated _Spatial Reference System_
  (SRS) that describes the organization of latitude and longitude for
  the variable. The SRS also provides geo-referencing information that
  enables analysis tools to account for irregularities in the Earth's
  geoid. In practice, Hyrax is often used with data that have global
  extent and so the SRS is _WGS84_ (aka _EPSG 4396_), and the current
  version of the WCS service uses that SRS by default. *TODO: WE ONLY SUPPORT EPSG-4396*
  
* The variable's fastest varying dimensions (e.g., the right-most
  dimensions in most system's representations) must be axes defined by
  the SRS (i.e., longitude and latitude) and they must match the SRS's
  axis' order.

* Other dimensions of the variable (e.g., ensemble set) must be 'to
  the left' of the dimensions defined by the SRS.

* The SRS's axes define the _domain_ of the coverage; the _range_ of
  the coverage is value of the variable. This value must have an
  associated _unit of measure_.

* The standard metadata for WCS 2.0 is limited to representing
  two-dimensional metadata, so fields in a dataset with three or more
  dimensions cannot be completely described by the
  _CoverageDescription_ response object because of limitations in the
  GML (link:http://www.opengeospatial.org/standards/gml[Geography
  Markup Language]). WCS 2.1, on the other hand, uses the CIS 1.1
  (link:http://docs.opengeospatial.org/is/09-146r6/09-146r6.html[Coverage
  Implementation Schema] standard and is more expressive with respect
  to the coverage's domain.

WARNING: The above might be wrong and is probably missing stuff. If
so, fix; if not, remove this note.

== WCS Installation

The WCS 2 service comes bundled as part of Hyrax-1.14.0 and newer.
See the link:https://www.opendap.org/software/hyrax-data-server[Hyrax
download and installation page] and this guide for configuration
information.

Assuming that you have Hyrax installed and running on your local system
you should be able to quickly verify the WCS service is available by
pointing your browser at the default WCS endpoint
`http://localhost:8080/opendap/wcs` Which should return a browser
renderable HTML page of the _Capabilities_ document with a conspicuously
empty _Contents_
section.

image::../images/WCS-NoContents.png[]


== Configuration

Because WCS requires certain metadata to work (whereas DAP can
function with nothing more than a variable's name and type), our
service provides a way to use WCS with DAP datasets that natively lack
the required WCS metadata. We do this by creating mappings (DynamicService
instances) between collections of DAP datasets that have similar
domain coordinates and a WCS service for the resulting Coverages.
These relationships are expressed the _wcs_service.xml_ configuration
file, as a simple XML document.

.wcs_service.xml
[source,xml,linenums]
----
<WcsService>
    <WcsCatalog className="opendap.wcs.v2_0.DynamicServiceCatalog">

        <DynamicService          <!--1-->
                prefix="M2SDNXSLV"   <!--2-->
                name="MERRA-2 M2SDNXSLV WCS Service" <!--3-->
                href="bes://^/testbed-13/M2SDNXSLV\.5\.12\.4/.*$" <!--4-->
                srs="urn:ogc:def:crs:EPSG::4326" >  <!--5-->
            <DomainCoordinate
                name="time"
                dapID="time"
                size="1"
                units="Days since 1900-01-01T00:00:00.000Z"
                min="690"
                max="690" />
            <DomainCoordinate
                name="latitude"
                dapID="lat"
                size="361"
                units="deg"
                min="-90"
                max="90" />
            <DomainCoordinate
                name="longitude"
                dapID="lon"
                size="576"
                units="deg"
                min="-180"
                max="180" />
        </DynamicService>
    </WcsCatalog>
</WcsService>
----

<1> The _DynamicService_ creates a WCS by creating a link between DAP datasets
matching the regex and the WCS meta information provided in the DynamicService definition.
<1> *prefix*: This is a simple string used by the WcsCatalog implementation to
distinguish each DynamicService. Choosing a value that is in some way related to the
collection being serviced can be helpful to people if there are problems later.
<1> *name*: A human readable and meaningful name that will be used by the server when it
creates a link to the service in the _viewers_ page.
<1> *href*: The value of *href* controls which of two fundamental ways the DynamicService
will be used. One way utilizes the BES as the source of metadata and adata for the
WCS service and the other utilizes a remote Hyrax service for the role. To use a local
BES the value of the `href` variable must begin with `bes://` and must be followed by a
regular expression that is used by Hyrax to determine which DAP datasets will be associated
with this DynamicService. In the example above the `href` attribute is set like this:

    href="bes://^/testbed-13/M2SDNXSLV\.5\.12\.4/.*$"

+
This value tells the server use the BES directly and to assocaiate this WCS definition with any DAP dataset
whose local path name on the server matches the regular expression

    `^/testbed-13/M2SDNXSLV\.5\.12\.4/.*$`

+
Which can be read as _"Anything that starts with `/testbed-13/M2SDNXSLV.5.12.4/` "_

<5> *srs*:  The _srs_ attribute defines the expected SRS for the coverages associated with this
DynamicService. The SRS defines the axis labels, order, units and
minimum number of domain coordinate dimensions and will be used for any dataset
that does not contain an explicit SRS definition. Currently only _urn:ogc:def:crs:EPSG::4326_ is
supported.


NOTE: Currently the only supported SRS is `urn:ogc:def:crs:EPSG::4326`

==== Domain Coordinate Definitions
The Hyrax WCS relies on the DynamicService definition to be
responsible for identifying the specific variables in the DAP datasets that are to be used for the geo-referenced domain coordinates of the coverage.
The domain coordinates must appear in the order that they appear in the dimensions of the DAP dataset. They must also match the order of axes represented in the SRS. _If there is an unresolvable conflict then until a suitable SRS can be identified the DAP dataset cannot be served as a Coverage._ Many DAP datasets have variables with more than two dimensions: latitude, longitude, elevation, and time are frequently seen as domain coordinates in scientific data. These can be utilized in the WCS as long as the inner most (last) two dimensions are in agreement with the SRS.

Let's consider the DomainCoordinate definitions from the example above:

-----
<DomainCoordinate
    name="time"
    dapID="time"
    size="1"
    units="Days since 1900-01-01T00:00:00.000Z"
    min="690"
    max="690" />
<DomainCoordinate
    name="latitude"
    dapID="lat"
    size="361"
    units="deg"
    min="-90"
    max="90" />
<DomainCoordinate
    name="longitude"
    dapID="lon"
    size="576"
    units="deg"
    min="-180"
    max="180" />
-----

In our friend EPSG:4326 we know that the axis order is `latitude, longitude` and that's the order in the example. There is also an additional time coordinate which comes prior to the defintions for `latitude` and `longitude`.

Consider the `latitude` DomainCoordinate:
-----
<DomainCoordinate name="latitude" dapID="lat" size="361" units="deg" min="-90.0" max="90.0"/>
-----

This tells the service that the coordinate axis named `latitude` is bound to the DAP variable `lat`, that a default value for _size_ as 361 elements, the default _units_ are degrees "deg", the default minimum value is -90.0 and the default maximum value is 90.0. What this means is that when the DynamicService processes a DAP dataset into a coverage it will check the dataset's metadata for this tyoe of information. If any of these values can be determined from the dataset metadata then that value is used, otherwise the values expressed in the DOmainCoordinate definition are used.

Longitude and time are handled as latitude.

==== Providing Field defintions
Many DAP datasets either lack the metadata for determining which variables will make suitable coverages, or the information may not be in an expected form or location. In order to enable these datasets to be exposed via WCS we allow the definition of a field in the DynamicService. Consider the following DynamicService definition:
----
<DynamicService
        prefix="coads"
        name="COADS WCS Service"
        href="bes://^.*coads.*\.nc$"
        srs="urn:ogc:def:crs:EPSG::4326">

    <DomainCoordinate
        name="time"
        dapID="time"
        size="12"
        units="hour since 0000-01-01 00:00:00"
        min="366.0"
        max="8401.335"/>

    <DomainCoordinate
        name="latitude"
        dapID="COADSY"
        size="90"
        units="deg"
        min="-90"
        max="90" />

    <DomainCoordinate
        name="longitude"
        dapID="COADSX"
        size="180"
        units="deg"
        min="-180"
        max="180" />

    <field
        name="SST"
        dapID="SST"
        description="SEA SURFACE TEMPERATURE"
        units="Deg C"
        min="-9.99999979e+33"
        max="9.99999979e+33"/>

    <field
        name="AIRT"
        dapID="AIRT"
        description="AIR TEMPERATURE"
        units="DEG C"
        min="-9.99999979e+33"
        max="9.99999979e+33"/>

    <field
        name="UWND"
        dapID="UWND"
        description="ZONAL WIND"
        units="M/S"
        min="-9.99999979e+33"
        max="9.99999979e+33"/>

    <field
        name="VWND"
        dapID="VWND"
        description="MERIDIONAL WIND"
        units="M/S"
        min="-9.99999979e+33"
        max="9.99999979e+33"/>
</DynamicService>
----
Each DAP variable in the dataset is exposed as a WCS field and basic information is provided that is required by WCS.

NOTE: When creating field definitions remember that WCS Field names must be valid https://stackoverflow.com/questions/1631396/what-is-an-xsncname-type-and-when-should-it-be-used[NCNAMEs] and that DAP variables do not have such a limitation. Characters like % or $ are not allowed in an NCNAME.





==== Reading from Servers that Require Authentication
TBD
