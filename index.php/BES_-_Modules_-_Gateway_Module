
<!DOCTYPE html>
<html lang="en" dir="ltr" class="client-nojs">
<head>
<title>BES - Modules - Gateway Module - OPeNDAP Documentation</title>
</head>
<body class="mediawiki ltr sitedir-ltr ns-0 ns-subject page-BES_-_Modules_-_Gateway_Module skin-monobook action-view">
<div id="globalWrapper">
<div id="column-content"><div id="content" class="mw-body-primary" role="main">
	
	
	<h1 id="firstHeading" class="firstHeading" lang="en"><span dir="auto">BES - Modules - Gateway Module</span></h1>
	<div id="bodyContent" class="mw-body">
		<div id="siteSub">From OPeNDAP Documentation</div>
		<div id="contentSub"></div>
		

		<!-- start content -->
<div id="mw-content-text" lang="en" dir="ltr" class="mw-content-ltr"><p>The Gateway Service provides interoperability between Hyrax and other web services. Using the Gateway module, Hyrax can be used to access and subset data served by other web services so long as those services return the data in a form Hyrax has been configured to serve. For example, if a web service returns data using HDF4 files, then Hyrax, using the gateway module, can subset and return DAP responses for those data.
</p>
<div id="toc" class="toc"><div id="toctitle"><h2>Contents</h2></div>
<ul>
<li class="toclevel-1 tocsection-1"><a href="#Special_options_supported_by_the_handler"><span class="tocnumber">1</span> <span class="toctext">Special options supported by the handler</span></a>
<ul>
<li class="toclevel-2 tocsection-2"><a href="#Limiting_access_to_specific_hosts"><span class="tocnumber">1.1</span> <span class="toctext">Limiting access to specific hosts</span></a></li>
<li class="toclevel-2 tocsection-3"><a href="#Recognizing_responses"><span class="tocnumber">1.2</span> <span class="toctext">Recognizing responses</span></a></li>
<li class="toclevel-2 tocsection-4"><a href="#Network_proxies_and_Performance_optimizations"><span class="tocnumber">1.3</span> <span class="toctext">Network proxies and Performance optimizations</span></a>
<ul>
<li class="toclevel-3 tocsection-5"><a href="#Using_Squid"><span class="tocnumber">1.3.1</span> <span class="toctext">Using Squid</span></a></li>
<li class="toclevel-3 tocsection-6"><a href="#Squid_and_Dynamic_Content"><span class="tocnumber">1.3.2</span> <span class="toctext">Squid and Dynamic Content</span></a></li>
<li class="toclevel-3 tocsection-7"><a href="#How_can_I_tell_if_a_service_sends_Cache_Control_headers"><span class="tocnumber">1.3.3</span> <span class="toctext">How can I tell if a service sends Cache Control headers</span></a></li>
<li class="toclevel-3 tocsection-8"><a href="#Using_Squid_on_OS.2FX"><span class="tocnumber">1.3.4</span> <span class="toctext">Using Squid on OS/X</span></a></li>
<li class="toclevel-3 tocsection-9"><a href="#Squid.2C_OS.2FX_and_Caching_Dynamic_Content"><span class="tocnumber">1.3.5</span> <span class="toctext">Squid, OS/X and Caching Dynamic Content</span></a></li>
</ul>
</li>
</ul>
</li>
<li class="toclevel-1 tocsection-10"><a href="#Known_Problems"><span class="tocnumber">2</span> <span class="toctext">Known Problems</span></a></li>
</ul>
</div>

<h2><span class="mw-headline" id="Special_options_supported_by_the_handler"><span class="mw-headline-number">1</span> Special options supported by the handler</span></h2>
<h3><span class="mw-headline" id="Limiting_access_to_specific_hosts"><span class="mw-headline-number">1.1</span> Limiting access to specific hosts</span></h3>
<p>Because this handler behaves like a web <i>client</i> there are some special options that need to be configured to make it work. When we distribute the client, it is limited to accessing only the local host. This prevents misuse (where your copy of Hyrax might be used to access all kinds of other sites). This gateway's configuration file contains a 'whitelist' of allowed hosts. Only hosts listed on the whitelist will be accessed by the gateway.
</p>
<dl>
<dt>Gateway.Whitelist</dt>
<dd> provides a list of URL of the form <i>protocol://host.domain:port</i> that will be passed through the gateway module. If a request is made to access a web service not listed on the Whitelist, Hyrax returns an error. Note that the whitelist can be more specific than just a hostname - it could in principal limit access to a specific set of requests to a particular web service. 
</dd>
</dl>
<p>example:
</p>
<pre>Gateway.Whitelist=<a rel="nofollow" class="external free" href="http://test.opendap.org/opendap">http://test.opendap.org/opendap</a>
Gateway.Whitelist+=<a rel="nofollow" class="external free" href="http://opendap.rpi.edu/opendap">http://opendap.rpi.edu/opendap</a>
</pre>
<h3><span class="mw-headline" id="Recognizing_responses"><span class="mw-headline-number">1.2</span> Recognizing responses</span></h3>
<dl>
<dt>Gateway.MimeTypes</dt>
<dd> provides a list of mappings from data handler module to returned mime types. When the remote service returns a response, if that response contains one of the listed MIME types (e.g., <i>application/x-hdf5</i>) then the gateway will process it using the named handler (e.g., <i>h5</i>). Note that if the service does not include this information the gateway will try other ways to figure out how to work with the response.
</dd>
</dl>
<p>These are the default types:
</p>
<pre>Gateway.MimeTypes=nc:application/x-netcdf
Gateway.MimeTypes+=h4:application/x-hdf
Gateway.MimeTypes+=h5:application/x-hdf5
</pre>
<h3><span class="mw-headline" id="Network_proxies_and_Performance_optimizations"><span class="mw-headline-number">1.3</span> Network proxies and Performance optimizations</span></h3>
<p>There are four parameters that are used to configure a proxy server that the gateway will use. Nominally this is used as a cache, so that files do not have to be repeatedly fetched from the remote service and that's why we consider this a 'performance' feature. We have tested the hander with Squid because it is widely used on both linux and OS/X and because in addition to it's proxy capabilities, it is often used as a cache. This can also be used to navigate firewalls.
</p>
<dl>
<dt>Gateway.ProxyProtocol</dt>
<dd> Which protocol(s) does this proxy support. Nominally this should be <i>http</i>.
</dd>
<dt>Gateway.ProxyHost</dt>
<dd> On what host does the proxy server operate? Often you want to use <i>localgost</i> for this.
</dd>
<dt>Gateway.ProxyPort</dt>
<dd> What port does the proxy listen on? Squid defaults to <i>3218</i>; some documentation for web accelerators
</dd>
<dt>Gateway.NoProxy</dt>
<dd> Provide a regular expression that describes URLs that should <i>not</i> be sent to the proxy. This is particularly useful for running the gateway on the hosts that stage the service accessed via the gateway. In this cases, a proxy/cache like squid may not process 'localhost' URLs unless its configuration is tweaked quite a bit (and there may be no performance advantage to having the proxy/cache store extra copies of the files given that they are on the host already). This parameter was added in version 1.1.0.
</dd>
</dl>
<pre>Gateway.ProxyProtocol= 
Gateway.ProxyHost=
Gateway.ProxyPort=
Gateway.NoProxy=
</pre>
<h4><span class="mw-headline" id="Using_Squid"><span class="mw-headline-number">1.3.1</span> Using Squid</span></h4>
<p>Squid makes a great cache for the gateway. In our testing we have used Squid only for services running on port 80.
</p><p>Squid is a powerful tool and it is worth looking at its <a rel="nofollow" class="external text" href="http://www.squid-cache.org/">web page</a>.
</p>
<h4><span class="mw-headline" id="Squid_and_Dynamic_Content"><span class="mw-headline-number">1.3.2</span> Squid and Dynamic Content</span></h4>
<p>Squid follows the HTTP/1.1 specification to determine what and how long to cache items. However, you may want to force Squid to ignore some of the information supplied by certain web services (or to different default values when the standard information is not present). If you are working with a web server that does not include caching control headers in its responses but does have 'cgi-bin' or '?' in the URL, here's how override Squid's default behavior (which is to never cache items returned from a 'dynamic' source (i.e., one with 'cgi-bin' or '?' in the URL). The value below will cause Squid to cache response from a dynamic source for 1440 minutes unless that response includes an Expires: header telling to cache to behave differently
</p><p>In the squid configuration file, find the lines:
</p>
<pre>
# refresh patterns (squid-recommended)
refresh_pattern ^ftp:		1440	20%	10080
refresh_pattern ^gopher:	1440	0%	1440
refresh_pattern -i (/cgi-bin/|\?) 0	0%	0
refresh_pattern .		0	20%	4320
</pre>
<p>And change the third refresh_pattern to read:
</p>
<pre>
refresh_pattern -i (/cgi-bin/|\?) 1440	20%	10080
</pre>
<h4><span class="mw-headline" id="How_can_I_tell_if_a_service_sends_Cache_Control_headers"><span class="mw-headline-number">1.3.3</span> How can I tell if a service sends Cache Control headers</span></h4>
<p>Here are two ways to check:
</p>
<ul>
<li> Go to <a rel="nofollow" class="external free" href="http://www.ircache.net/cgi-bin/cacheability.py">http://www.ircache.net/cgi-bin/cacheability.py</a>
</li>
<li> <i>curl -i &lt;URL&gt; | more</i> and look at the headers at the top of the message.
</li>
</ul>
<h4><span class="mw-headline" id="Using_Squid_on_OS.2FX"><span class="mw-headline-number">1.3.4</span> Using Squid on OS/X</span></h4>
<p>If you're using OS/X to run Hyrax, the easiest
Squid port is <a rel="nofollow" class="external text" href="http://web.me.com/adg/squidman/index.html">SquidMan</a>.
We tested version SquidMan 3.0 (Squid 3.1.1). Run the SquidMan
application and under <i>Preferences... General</i> set the port to
something like 3218, the cache size to something big (16GB) and
Maximum object size to 256M. Click 'Save' and you're almost done. 
</p><p>Now in the <i>gateway.conf</i> file, set the proxy parameters like so:
</p>
<pre>Gateway.ProxyProtocol=http
Gateway.ProxyHost=localhost
Gateway.ProxyPort=3218
Gateway.NoProxy=http://localhost.*
</pre>
<p>assuming you're running both Squid and Hyrax on the same host.
</p><p>Restart the BES and you're all set. 
</p><p>To test, make some requests using the gateway
(<a rel="nofollow" class="external free" href="http://localhost/opendap/gateway">http://localhost/opendap/gateway</a>) and click on SquidMan's 'Access
Log' button to see the caching at work. The first access, which
fetches the data, will say <i>DIRECT/&lt;ip number&gt;</i> while cache hits
will be labeled <i>NONE/-</i>.
</p>
<h4><span class="mw-headline" id="Squid.2C_OS.2FX_and_Caching_Dynamic_Content"><span class="mw-headline-number">1.3.5</span> Squid, OS/X and Caching Dynamic Content</span></h4>
<p>By default SquidMan does not cache dynamic content that lacks cache control headers in the response. To hack the squid.conf file and make the change in the <i>refresh_pattern</i> described above do the following:
</p>
<ol>
<li> Under Preferences... choose the 'Template' tab and scroll to the bottom of the text;<a href="../index.php/File:Edit_the_squid.conf_file.png" class="image"><img alt="Edit the squid.conf file.png" src="../images/thumb/9/9b/Edit_the_squid.conf_file.png/200px-Edit_the_squid.conf_file.png" width="200" height="136" srcset="/images/thumb/9/9b/Edit_the_squid.conf_file.png/300px-Edit_the_squid.conf_file.png 1.5x, /images/thumb/9/9b/Edit_the_squid.conf_file.png/400px-Edit_the_squid.conf_file.png 2x" /></a>
</li>
<li> Edit the line, replacing "0 0% 0" with "1440 20% 10080"; and
</li>
<li> 'Save' and then 'Stop Squid' and 'Start Squid' (note the helpful status messages in the 'Start/Stop' window).<a href="../index.php/File:Squid_1.png" class="image"><img alt="Squid 1.png" src="../images/thumb/a/a6/Squid_1.png/200px-Squid_1.png" width="200" height="105" srcset="/images/thumb/a/a6/Squid_1.png/300px-Squid_1.png 1.5x, /images/thumb/a/a6/Squid_1.png/400px-Squid_1.png 2x" /></a><a href="../index.php/File:Squid_2.png" class="image"><img alt="Squid 2.png" src="../images/thumb/c/cc/Squid_2.png/200px-Squid_2.png" width="200" height="105" srcset="/images/thumb/c/cc/Squid_2.png/300px-Squid_2.png 1.5x, /images/thumb/c/cc/Squid_2.png/400px-Squid_2.png 2x" /></a><a href="../index.php/File:Squid_3.png" class="image"><img alt="Squid 3.png" src="../images/thumb/8/88/Squid_3.png/200px-Squid_3.png" width="200" height="105" srcset="/images/thumb/8/88/Squid_3.png/300px-Squid_3.png 1.5x, /images/thumb/8/88/Squid_3.png/400px-Squid_3.png 2x" /></a>
</li>
</ol>
<h2><span class="mw-headline" id="Known_Problems"><span class="mw-headline-number">2</span> Known Problems</span></h2>
<p>For version 1.0.1 of the gateway, we know about the following problems:
</p>
<ol>
<li> Squid does not cache requests to localhost, but our use of the proxy server does not by-pass requests to localhost. Thus, using the gateway to access data from a service running on localhost will fail when using squid since the gateway will route the request to the proxy (i.e., squid) where it will generate an error.
</li>
<li> Not using a caching proxy server will result in poor performance.
</li>
</ol>


</div>
				<!-- end content -->
				<div class="visualClear"></div>
	</div>
</div></div>
</body></html>